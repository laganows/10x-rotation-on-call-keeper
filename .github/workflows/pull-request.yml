name: Pull Request

on:
  pull_request:
    branches: [master]
    types: [opened, synchronize, reopened, ready_for_review]

jobs:
  lint:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Setup Node and install dependencies
        uses: ./.github/actions/setup-node
      - name: Run lint
        run: npm run lint

  unit-test:
    runs-on: ubuntu-latest
    needs: lint
    permissions:
      contents: read
    steps:
      - name: Setup Node and install dependencies
        uses: ./.github/actions/setup-node
      - name: Run unit tests with coverage
        run: npm run test:unit -- --run --coverage
      - name: Upload unit coverage
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: unit-coverage
          path: coverage/unit
          if-no-files-found: error

  e2e-test:
    runs-on: ubuntu-latest
    needs: lint
    environment: e2e
    permissions:
      contents: read
    env:
      PUBLIC_SUPABASE_URL: ${{ secrets.PUBLIC_SUPABASE_URL }}
      PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.PUBLIC_SUPABASE_ANON_KEY }}
      PUBLIC_AUTH_REQUIRED:  ${{ secrets.PUBLIC_AUTH_REQUIRED }}
      DEFAULT_USER_ID: ${{ secrets.DEFAULT_USER_ID }}
      E2E_USERNAME_ID: ${{ secrets.E2E_USERNAME_ID }}
      E2E_USERNAME: ${{ secrets.E2E_USERNAME }}
      E2E_PASSWORD: ${{ secrets.E2E_PASSWORD }}
    steps:
      - name: Setup Node and install dependencies
        uses: ./.github/actions/setup-node
      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium
      - name: Run E2E tests
        run: npm run test:e2e -- --reporter=html
      - name: Upload E2E report artifacts
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: e2e-report
          path: |
            playwright-report
            test-results
          if-no-files-found: warn

  status-comment:
    runs-on: ubuntu-latest
    needs: [lint, unit-test, e2e-test]
    if: ${{ always() }}
    permissions:
      contents: read
      issues: write
      pull-requests: write
    steps:
      - name: Comment PR status
        uses: actions/github-script@v8
        with:
          script: |
            const { owner, repo } = context.repo;
            const issueNumber = context.issue.number;
            if (!issueNumber) {
              core.info("No pull request number found for this event.");
              return;
            }

            const results = {
              lint: "${{ needs.lint.result }}",
              unit: "${{ needs.unit-test.result }}",
              e2e: "${{ needs.e2e-test.result }}",
            };
            const failedJobs = Object.entries(results)
              .filter(([, result]) => result !== "success")
              .map(([name, result]) => `${name}: ${result}`);

            const runUrl = `${context.serverUrl}/${owner}/${repo}/actions/runs/${context.runId}`;
            const body =
              failedJobs.length === 0
                ? [
                    "✅ Lint, unit tests, and E2E tests passed.",
                    "",
                    `Run: ${runUrl}`,
                  ].join("\n")
                : [
                    "❌ One or more checks failed.",
                    "",
                    "Results:",
                    ...failedJobs.map((line) => `- ${line}`),
                    "",
                    `Run: ${runUrl}`,
                  ].join("\n");

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: issueNumber,
              body,
            });
